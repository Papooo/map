<!DOCTYPE html>
<html>
    <head>
        <title>Simple Map</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <style>
            html,
            body {
                font-family: Arial, sans-serif;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            .container {
                height: 100%;
                position: relative;
                }
                input {
                font-size: 12px;
            }
            h1 {
                color: #525454;
                font-size: 22px;
                margin: 0 0 10px 0;
                text-align: center;
            }
            #hide-listings,
            #show-listings {
                width: 48%;
            }
            #map {
                bottom:0px;
                height: 100%;
                left: 362px;
                position: absolute;
                right: 0px;
            }
            .options-box {
                background: #fff;
                border: 1px solid #999;
                border-radius: 3px;
                height: 100%;
                line-height: 35px;
                padding: 10px 10px 30px 10px;
                text-align: left;
                width: 340px;
            }
            #pano {
              width: 200px;
              height: 200px;
            }
            .text {
              font-size: 12px;
            }
            #toggle-drawing {
              width: 27%;
              position: relative;
              margin-left: 10px;
            }
            #zoom-to-area-text {
              position: relative;
              width: 70%;
            }
            #zoom-to-area {
              width: 24%;
            }

        </style>
        <script src="js/app.js"></script>

    </head>
    <body>
        <div class="container">
            <div class="options-box">
                <h1>Vilniaus Vaizdai</h1>
                <div class="">
                    <input id="show-listings" type="button" name="" value="Show Listings">
                    <input id="hide-listings" type="button" name="" value="Hide Listings">
                    <hr>
                    <span class="text">Draw a shape for search area</span>
                    <input id="toggle-drawing" type="button" name="" value="Drawing Tools">
                </div>
                <hr>
                <div class="">
                    <input id="zoom-to-area-text" type="text" name="" value="Riovonys" placeholder="Enter your area">
                    <input id="zoom-to-area" type="button" name="" value="Zoom">
                </div>
            </div>
        </div>
        <div id="map"></div>

        <script>
            var map;
            var markers = [];
            var polygon = null;

            function initMap() {
                var styles = [
                    {
                        "featureType": "road",
                        "elementType": "labels",
                        "stylers": [ { "saturation": -100 } ]
                    },
                    {
                        "featureType": "water",
                        // "elementType": "labels",
                        "stylers": [ { "color": "#FFFFFF" } ]
                    },

                ];
                var sn = {lat: 54.678296, lng: 25.314064};
                var locations = [
                        {title: 'pirmas', location: {lat: 54.678296, lng: 25.414061}},
                        {title: 'antras', location: {lat: 54.666666, lng: 25.312956}},
                        {title: 'trecias', location: {lat: 54.653288, lng: 25.314094}},
                        {title: 'ketvirtas', location: {lat: 54.653288, lng: 25.394064}},
                        {title: 'penktas', location: {lat: 54.653288, lng: 25.222718}}
                    ];
                var largeInfoWindow = new google.maps.InfoWindow();
                var myMarker = makeMarkerIcon('c0c0c0');
                var voMarker = makeMarkerIcon('587469');

                var drawingManager = new google.maps.drawing.DrawingManager({
                    drawingMode: google.maps.drawing.OverlayType.POLYGON,
                    drawingControl: true,
                    drawingControlOptions: {
                        position: google.maps.ControlPosition.TOP_LEFT,
                        drawingModes: [
                            google.maps.drawing.OverlayType.POLYGON
                        ]
                    }
                });

                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 54.678296, lng: 25.314064},
                    zoom: 15,
                    styles: styles,
                    mapTypeControl: true
                });

                for (var i = 0; i < locations.length; i++) {
                    console.log(i);
                    var position = locations[i].location;
                    var title = locations[i].title;
                    var marker = new google.maps.Marker({
                            // map: map,
                            position: position,
                            title: title,
                            id: i,
                            icon: myMarker,
                            animation: google.maps.Animation.DROP
                    });

                    markers.push(marker);

                    marker.addListener('click', function(){
                        populateInfoWindow(this, largeInfoWindow);
                    });

                    marker.addListener('mouseover', function() {
                        this.setIcon(voMarker);
                    });

                    marker.addListener('mouseout', function() {
                        this.setIcon(myMarker);
                    });
                }

                document.getElementById('show-listings').addEventListener('click', showListings);
                document.getElementById('hide-listings').addEventListener('click', hideListings);
                document.getElementById('toggle-drawing').addEventListener('click', function() {
                    toggleDrawing(drawingManager);
                });
                document.getElementById('zoom-to-area').addEventListener('click', function() {
                    zoomToArea();
                });
                drawingManager.addListener('overlaycomplete', function(event) {
                    if (polygon) {
                        polygon.setMap(null);
                        hideListings();
                    }
                    drawingManager.setDrawingMode(null);
                    polygon = event.overlay;
                    polygon.setEditable(true);
                    searchWithinPolygon();
                    polygon.getPath().addListener('set_at', searchWithinPolygon);
                    polygon.getPath().addListener('insert_at', searchWithinPolygon);
                    var area = google.maps.geometry.spherical.computeArea(polygon.getPath());
                    console.log('plotas ' + area + 'm2');

                });

                function populateInfoWindow(marker, infowindow) {
                  // Check to make sure the infowindow is not already opened on this marker.
                  if (infowindow.marker != marker) {
                    // Clear the infowindow content to give the streetview time to load.
                    infowindow.setContent('');
                    infowindow.marker = marker;
                    // Make sure the marker property is cleared if the infowindow is closed.
                    infowindow.addListener('closeclick', function() {
                      infowindow.marker = null;
                    });
                    var streetViewService = new google.maps.StreetViewService();
                    var radius = 50;
                    // In case the status is OK, which means the pano was found, compute the
                    // position of the streetview image, then calculate the heading, then get a
                    // panorama from that and set the options
                    function getStreetView(data, status) {
                      if (status == google.maps.StreetViewStatus.OK) {
                        var nearStreetViewLocation = data.location.latLng;
                        var heading = google.maps.geometry.spherical.computeHeading(
                          nearStreetViewLocation, marker.position);
                          infowindow.setContent('<div>' + marker.title + '</div><div id="pano"></div>');
                          var panoramaOptions = {
                            position: nearStreetViewLocation,
                            pov: {
                              heading: heading,
                              pitch: 30
                            }
                          };
                        var panorama = new google.maps.StreetViewPanorama(
                          document.getElementById('pano'), panoramaOptions);
                      } else {
                        infowindow.setContent('<div>' + marker.title + '</div>' +
                          '<div>No Street View Found</div>');
                      }
                    }
                    // Use streetview service to get the closest streetview image within
                    // 50 meters of the markers position
                    streetViewService.getPanoramaByLocation(marker.position, radius, getStreetView);
                    // Open the infowindow on the correct marker.
                    infowindow.open(map, marker);
                  }
                }

                function showListings() {
                    var bounds = new google.maps.LatLngBounds();
                    for (var i = 0; i < markers.length; i++) {
                        markers[i].setMap(map);
                        bounds.extend(markers[i].position);
                    }
                    map.fitBounds(bounds);
                }

                function hideListings() {
                    for (var i = 0; i < markers.length; i++) {
                        markers[i].setMap(null);
                    }
                }

                // This function takes in a COLOR, and then creates a new marker
                // icon of that color. The icon will be 21 px wide by 34 high, have an origin
                // of 0, 0 and be anchored at 10, 34).
                function makeMarkerIcon(markerColor) {
                    var markerImage = new google.maps.MarkerImage(
                        'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+ markerColor +
                        '|40|_|%E2%80%A2',
                        new google.maps.Size(21, 34),
                        new google.maps.Point(0, 0),
                        new google.maps.Point(10, 34),
                        new google.maps.Size(21,34));

                    return markerImage;
                }

                var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
                var snMarker = new google.maps.Marker({
                    // You can allow users to move a marker on the map by setting the marker's draggable property to true
                    draggable: true,
                    position: sn,
                    map: map,
                    label: 'Monika',
                    icon: image,
                    // Can be animation DROP
                    // You may initiate an animation on an existing marker by calling setAnimation() on the Marker object.
                    animation: google.maps.Animation.BOUNCE,
                    // The marker's title will appear as a tooltip.
                    title: "SoftNova"
                });

                var infoWindow = new google.maps.InfoWindow(
                    {
                        content: 'Lan: ' + sn.lat + '<br>' + 'Lng: ' + sn.lng
                    }
                );

                snMarker.addListener('click', function(){
                    infoWindow.open(map, snMarker);
                });

                // To remove a marker from the map, call the setMap() method passing null as the argument.

                // marker.setMap(null);

            }
            function toggleDrawing(drawingManager) {
                if (drawingManager.map) {
                    drawingManager.setMap(null);
                    if (polygon !== null) {
                        polygon.setMap(null);
                    }
                } else {
                    drawingManager.setMap(map);
                }
            }

            // function searchWithinPolygon() {
            //     for (var i = 0; i < markers.length; i++) {
            //         if (google.maps.geometry.poly.containsLocation(markers.[i].position, polygon)) {
            //             markers[i].setMap(map);
            //         } else {
            //             markers[i].setMap(null);
            //         }
            //     }
            // }
            //
            function searchWithinPolygon() {
              for (var i = 0; i < markers.length; i++) {
                if (google.maps.geometry.poly.containsLocation(markers[i].position, polygon)) {
                  markers[i].setMap(map);
                } else {
                  markers[i].setMap(null);
                }
              }
            }

            function zoomToArea() {
                var address = document.getElementById('zoom-to-area-text').value;
                var geocoder =  new google.maps.Geocoder();

                if (address == '') {
                    window.aler('Please enter address');
                } else {
                    geocoder.geocode(
                        {
                            address: address,
                            componentRestrictions: {locality: 'Vilnius'}
                        },
                        function (results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                                map.setCenter(results[0].geometry.location);
                                map.setZoom(15);
                                window.alert(results[0]);
                            } else {
                                window.alert('Ups, not found');
                            }
                        }
                    );
                }

            }

        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi-ZIKWRA1xBrdtjWepic1KSQhntDTRhM&callback=initMap&libraries=geometry,drawing"
        async defer></script>
    </body>
</html>
